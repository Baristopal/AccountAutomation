@page "/data/data-entry"
@using Business.Enums
@using Core.Utilities.Helpers
@using Entities.Dto

@inject IDataService dataService
@inject IDefinationService definationService

<PageTitle>Veri Girişi</PageTitle>

<MudOverlay Visible="@isBusy" DarkBackground="true">
    <MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
</MudOverlay>

<MudStack Class="mb-2 pa-4" Row=true Justify="Justify.SpaceBetween">
    <MudItem Style="width:105px;">
        <MudText Align="Align.Start" Typo="Typo.h5" Color="Color.Primary">Veri Giriş</MudText>
    </MudItem>

    <MudGrid Class="d-flex justify-end" Spacing="1">
        <MudItem xs="1">
            <MudNumericField T="decimal" Variant="Variant.Outlined" Label="USD Kur" HideSpinButtons=true Margin="Margin.Dense" @bind-Value="data.USDExchange"></MudNumericField>
        </MudItem>
        <MudItem xs="1">
            <MudNumericField T="decimal" Variant="Variant.Outlined" Label="EURO Kur" HideSpinButtons=true Margin="Margin.Dense" @bind-Value="data.EURExchange"></MudNumericField>
        </MudItem>
        <MudItem>

            <MudFab StartIcon="@Icons.Material.Filled.Add" Label="Ekle" Color="Color.Primary" IconSize="Size.Small" OnClick="Add"></MudFab>
            @if (dataCount > 1)
            {
                <MudFab StartIcon="@Icons.Material.Filled.Add" Label="Sil" Color="Color.Error" IconSize="Size.Small" OnClick="Delete"></MudFab>
            }
        </MudItem>
    </MudGrid>
</MudStack>

<MudPaper Outlined=false Elevation="0">
    <MudGrid Class="pa-4" Spacing="1">
        <MudItem xs="2">
            <MudSelect T="string" Label="İşlem Tipi" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Margin="Margin.Dense" Dense=true @bind-Value="data.ProcessType">
                @foreach (var item in EnumHelper<ProcessTypeEnum>.GetNamesAndDisplayNames(typeof(ProcessTypeEnum)))
                {
                    <MudSelectItem Value="@item.Key">@item.Value</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="2">
            <MudDatePicker Label="Tarih" Variant="Variant.Outlined" Margin="Margin.Dense" @bind-Date="data.ProcessDate"></MudDatePicker>
        </MudItem>
        <MudItem xs="2">
            <MudDatePicker Label="Vade Tarihi" Variant="Variant.Outlined" Margin="Margin.Dense" @bind-Date="data.MaturityDate"></MudDatePicker>
        </MudItem>
        <MudItem xs="2">
            <MudSelect T="string" Label="İşlem Türü" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Margin="Margin.Dense" Dense=true @bind-Value="data.SalesType">
                @foreach (var item in EnumHelper<PurchaseTypeEnum>.GetNamesAndDisplayNames(typeof(PurchaseTypeEnum)))
                {
                    <MudSelectItem Value="@item.Key">@item.Value</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="2">
            <MudTextField T="string" Label="Fatura No" Variant="Variant.Outlined" Margin="Margin.Dense" @bind-Value="data.InvoiceNumber"></MudTextField>
        </MudItem>
        <MudItem xs="2">
            <MudTextField T="string" Label="Açıklama" Variant="Variant.Outlined" Margin="Margin.Dense" @bind-Value="data.Description"></MudTextField>
        </MudItem>
    </MudGrid>
    @for (int i = 0; i < dataCount; i++)
    {
        var index = i;

        <MudGrid Class="pa-4" Spacing="1">
            <MudItem xs="2">
                <MudSelect T="string" Label="Masraf Adı" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Margin="Margin.Dense" Dense=true ValueChanged="@(s=>AddOrUpdateExpenseType(s,index))">
                    @foreach (var type in expenseTypes)
                    {
                        <MudSelectItem Value="@type.Name">@type.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="1">
                <MudNumericField T="int" Variant="Variant.Outlined" HideSpinButtons=true Label="Stok Adet" Margin="Margin.Dense" Min="1" ValueChanged="@(s=>AddOrUpdateStock(s,index))"></MudNumericField>
            </MudItem>
            <MudItem xs="1">
                <MudSelect T="string" Label="Birim" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Margin="Margin.Dense" Dense=true ValueChanged="@(s=>AddOrUpdateUnit(s,index))">
                    @foreach (var item in EnumHelper<UnitEnum>.GetNamesAndDisplayNames(typeof(UnitEnum)))
                    {
                        <MudSelectItem Value="@item.Key">@item.Value</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="2">
                <MudNumericField T="decimal" Variant="Variant.Outlined" HideSpinButtons=true Label="KDV Tutarı" Margin="Margin.Dense" ValueChanged="@(s=> AddOrUpdateTaxAmount(s,index))"></MudNumericField>
            </MudItem>
            <MudItem xs="2">
                <MudSelect T="string" Label="Döviz Birimi" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Margin="Margin.Dense" Dense=true ValueChanged="@(s=>AddOrUpdateCurrency(s,index))">
                    @foreach (var item in Enum.GetNames(typeof(CurrencyEnum)))
                    {
                        <MudSelectItem Value="@item">@item</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="2">
                <MudNumericField T="decimal" Variant="Variant.Outlined" HideSpinButtons=true Label="Döviz İşlem Toplamı" Margin="Margin.Dense" ValueChanged="@(s=>AddOrUpdateCurrencyTotalAmount(s,index))"></MudNumericField>
            </MudItem>
            <MudItem xs="2">
                <MudNumericField T="decimal" Variant="Variant.Outlined" HideSpinButtons=true Label="TL İşlem Toplamı" Margin="Margin.Dense" ValueChanged="@(s=>AddOrUpdateTLTotalAmount(s,index))"></MudNumericField>
            </MudItem>
        </MudGrid>
    }
    <MudItem Class="d-flex justify-end mr-4">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" OnClick="Submit">Kaydet</MudButton>
    </MudItem>
</MudPaper>
@code {

    private bool isBusy = false;

    private DataModel data = new();

    private int dataCount = 1;

    private void Add() => dataCount++;
    private void Delete()
    {
        if (dataCount == dataEntries.Count == false)
            dataCount--;
    }

    private List<DataEntryDto> dataEntries = new();
    private List<ExpenseTypeModel> expenseTypes = new();

    protected override async Task OnInitializedAsync()
    {
        isBusy = true;
        expenseTypes = (await definationService.GetAll<ExpenseTypeModel>()).Data.ToList();
        isBusy = false;
    }

    private async Task Submit()
    {
        isBusy = true;
        foreach (var dataEntry in dataEntries)
        {
            data.ExpenseType = dataEntry.ExpenseType;
            data.Stock = dataEntry.Stock;
            data.Unit = dataEntry.Unit;
            data.TaxAmount = dataEntry.TaxAmount;
            data.Currency = dataEntry.Currency;
            data.CurrencyTotalAmount = dataEntry.CurrencyTotalAmount;
            data.TLTotalAmount = dataEntry.TLTotalAmount;

            if (data.Currency == "USD")
                data.TLTotalAmount = data.CurrencyTotalAmount * data.USDExchange;
            else if (data.Currency == "EUR")
                data.TLTotalAmount = data.CurrencyTotalAmount * data.EURExchange;

            var result = await dataService.AddData(data);
            if (result.Success)
            {
                dataEntries.Clear();
                dataCount = 1;
                data.Id = Guid.NewGuid().ToString();
            }

        }

        isBusy = false;
    }

    #region Ekleme Güncelleme Methodları

    private void AddOrUpdateExpenseType(string type, int index)
    {
        var dataEntry = dataEntries.ElementAtOrDefault(index);
        if (dataEntry == null)
            dataEntries.Add(new DataEntryDto()
                {
                    ExpenseType = type,
                });
        else
            dataEntry.ExpenseType = type;
    }

    private void AddOrUpdateStock(int stock, int index)
    {
        var dataEntry = dataEntries.ElementAtOrDefault(index);
        if (dataEntry == null)
            dataEntries.Add(new DataEntryDto()
                {
                    Stock = stock
                });
        else
            dataEntry.Stock = stock;
    }

    private void AddOrUpdateUnit(string unit, int index)
    {
        var dataEntry = dataEntries.ElementAtOrDefault(index);
        if (dataEntry == null)
            dataEntries.Add(new DataEntryDto()
                {
                    Unit = unit
                });
        else
            dataEntry.Unit = unit;
    }

    private void AddOrUpdateTaxAmount(decimal taxAmount, int index)
    {
        var dataEntry = dataEntries.ElementAtOrDefault(index);
        if (dataEntry == null)
            dataEntries.Add(new DataEntryDto()
                {
                    TaxAmount = taxAmount
                });
        else
            dataEntry.TaxAmount = taxAmount;
    }

    private void AddOrUpdateCurrency(string currency, int index)
    {
        var dataEntry = dataEntries.ElementAtOrDefault(index);
        if (dataEntry == null)
            dataEntries.Add(new DataEntryDto()
                {
                    Currency = currency
                });
        else
            dataEntry.Currency = currency;
    }

    private void AddOrUpdateCurrencyTotalAmount(decimal currencyTotalAmount, int index)
    {
        var dataEntry = dataEntries.ElementAtOrDefault(index);
        if (dataEntry == null)
            dataEntries.Add(new DataEntryDto()
                {
                    CurrencyTotalAmount = currencyTotalAmount
                });
        else
            dataEntry.CurrencyTotalAmount = currencyTotalAmount;
    }

    private void AddOrUpdateTLTotalAmount(decimal TLTotalAmount, int index)
    {
        var dataEntry = dataEntries.ElementAtOrDefault(index);
        if (dataEntry == null)
            dataEntries.Add(new DataEntryDto()
                {
                    TLTotalAmount = TLTotalAmount
                });
        else
            dataEntry.TLTotalAmount = TLTotalAmount;
    }
    #endregion

}
